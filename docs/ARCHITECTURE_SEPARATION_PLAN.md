# フロントエンド・管理画面分離設計書

## 概要

現在のシステムをセキュリティ強化のために、一般ユーザー向けフロントエンドと管理者専用画面に分離します。

## 現在の問題点

1. **セキュリティリスク**: YouTube API Keyがフロントエンドに露出
2. **運用リスク**: API制限管理が困難
3. **メンテナンス性**: 設定変更にソースコード修正が必要

## 新しいアーキテクチャ

### システム構成

```
[一般ユーザー] → [フロントエンド(chatbot.html)] → [管理用バックエンド] → [YouTube API]
                         ↓                              ↓
                   [Live2D + 音声]                [管理画面(admin.html)]
                                                        ↓
                                                  [認証 + 設定管理]
```

## ファイル構成（分離後）

```
chatbot_sage/
├── public/                          # 一般ユーザー向け（公開用）
│   ├── index.html                   # チャットボット画面（YouTube設定削除）
│   ├── style.css                    # フロントエンド専用スタイル
│   ├── script.js                    # フロントエンド専用ロジック
│   ├── live2d-pixi.js              # Live2D制御
│   ├── emotion-analyzer-v2.js       # 感情分析（クライアント側）
│   ├── models/                      # Live2Dモデル
│   └── libs/                        # ライブラリ
├── admin/                           # 管理者専用（認証必須）
│   ├── index.html                   # 管理画面（セキュリティ向上のためadmin.htmlから変更）
│   ├── admin-style.css              # 管理画面専用スタイル
│   ├── admin-script.js              # 管理画面ロジック
│   └── auth.js                      # 認証処理
├── server/                          # バックエンドAPI
│   ├── app.js                       # Express.jsサーバー
│   ├── youtube-api.js               # YouTube API ラッパー
│   ├── auth-middleware.js           # 認証ミドルウェア
│   ├── config.js                    # 設定管理
│   └── package.json                 # 依存関係
└── docs/                           # ドキュメント
```

## コンポーネント詳細

### 1. 一般ユーザー向けフロントエンド（public/）

#### 機能範囲
- ✅ チャットインターフェース
- ✅ Live2Dキャラクター表示
- ✅ 音声合成（3エンジン対応）
- ✅ 感情分析・表情制御
- ❌ YouTube設定（管理画面に移動）
- ✅ YouTubeメッセージ受信・表示

#### セキュリティ
- API Key情報なし
- 設定変更権限なし
- 読み取り専用でチャットメッセージ受信

### 2. 管理者専用画面（admin/）

#### 機能範囲
- 🔐 認証ログイン
- ⚙️ YouTube API Key管理
- 📺 ライブ配信設定
- 📊 ダッシュボード（接続状況、統計）
- 🔧 システム設定
- 📝 ログ確認

#### 主要機能
1. **認証システム**
   - パスワード認証
   - セッション管理
   - 自動ログアウト

2. **YouTube設定管理**
   - API Key登録・更新
   - 配信ID設定
   - チェック間隔調整
   - 接続テスト機能

3. **システム監視**
   - ライブチャット接続状況
   - API使用量監視
   - エラーログ表示

### 3. バックエンドAPI（server/）

#### 技術スタック
- **Runtime**: Node.js
- **Framework**: Express.js
- **認証**: express-session + bcrypt
- **設定保存**: JSON File または SQLite
- **環境変数**: dotenv

#### API エンドポイント

```
GET  /api/auth/login          # 認証
POST /api/auth/logout         # ログアウト
GET  /api/youtube/status      # YouTube接続状況
POST /api/youtube/connect     # 接続開始
POST /api/youtube/disconnect  # 接続停止
GET  /api/youtube/messages    # チャットメッセージ取得（フロント用）
GET  /api/config              # 設定取得（管理用）
POST /api/config              # 設定保存（管理用）
GET  /api/logs                # ログ取得（管理用）
```

## 実装計画

### Phase 1: バックエンドAPI構築
1. Express.jsサーバー作成
2. 認証ミドルウェア実装
3. YouTube API ラッパー作成
4. 設定管理システム構築

### Phase 2: 管理画面開発
1. 認証画面作成
2. ダッシュボード実装
3. YouTube設定UI構築
4. 監視・ログ機能追加

### Phase 3: フロントエンド改修
1. YouTube設定UI削除
2. API経由でのメッセージ取得に変更
3. 認証不要のシンプル化

### Phase 4: セキュリティ強化
1. HTTPS必須化
2. CORS設定最適化
3. レート制限実装
4. セキュリティヘッダー追加

## セキュリティ上の改善点

### Before（現在）
- ❌ API KeyがLocalStorageに保存
- ❌ フロントエンドJavaScriptで直接API呼び出し
- ❌ 第三者がAPI Keyを取得可能

### After（分離後）
- ✅ API Keyはサーバーサイドで管理
- ✅ 認証された管理者のみアクセス可能
- ✅ フロントエンドは結果の表示のみ

## 運用上の改善点

### 設定管理
- **現在**: コード修正が必要
- **改善後**: 管理画面で即座に変更可能

### 監視・デバッグ
- **現在**: ブラウザコンソールのみ
- **改善後**: 専用ログ画面で集中管理

### API制限管理
- **現在**: 制限到達後の対処が困難
- **改善後**: 使用量監視とアラート機能

## デプロイメント

### 開発環境
```bash
# バックエンド
cd server && npm install && npm run dev

# フロントエンド
cd public && python -m http.server 8080

# 管理画面
cd admin && python -m http.server 8081
```

### 本番環境
- **フロントエンド**: 静的ホスティング（Netlify, Vercel等）
- **管理画面**: 認証付きホスティング
- **バックエンド**: Cloud Run, Heroku, VPS等

## 移行手順

1. **既存データのバックアップ**
   - LocalStorageの設定値を控える
   - 現在の動作状況を確認

2. **バックエンド構築・テスト**
   - ローカル環境でAPI開発
   - YouTube API連携テスト

3. **管理画面開発・統合**
   - 認証システム構築
   - 設定UI作成・テスト

4. **フロントエンド改修**
   - YouTube設定削除
   - API経由通信に変更

5. **本番デプロイ・移行**
   - 段階的リリース
   - 動作確認・調整

## 想定される課題と対策

### 課題1: 複雑性の増加
- **対策**: 段階的実装、十分なドキュメント化

### 課題2: インフラコスト
- **対策**: 軽量なバックエンド実装、無料プランの活用

### 課題3: 管理の手間
- **対策**: 直感的な管理画面、自動化機能

## 実装完了報告 (2025年6月11日)

### ✅ 分離アーキテクチャ実装完了

**実装済み機能:**
- ✅ 3層アーキテクチャ分離（フロントエンド・バックエンド・管理画面）
- ✅ Express.jsバックエンドAPI
- ✅ 認証システム（bcrypt + Express-session）
- ✅ セキュアな設定管理
- ✅ WebSocket統合システム
- ✅ **統合起動・停止システム** (NEW)

### 🚀 統合起動システム追加実装

**Phase 4: 運用性向上 (追加実装)**

#### 4.1 統合起動システム
- **統合コマンド**: `npm start`, `npm stop`, `npm run dev`
- **自動プロセス管理**: PIDファイルによる確実な制御
- **ポート競合解決**: 既存プロセスの自動停止・再起動
- **依存関係管理**: 初回起動時の自動インストール
- **ログ管理**: サーバー別ログファイル分離

#### 4.2 開発体験向上
- **色付きログ**: chalk v4による分かりやすい表示
- **リアルタイム監視**: 開発モードでのファイル監視
- **エラーハンドリング**: 堅牢なエラー処理と復旧
- **クリーンアップ**: 一時ファイルの自動削除

#### 4.3 技術実装詳細
```javascript
// scripts/start-all.js - 統合起動制御
// scripts/stop-all.js - 統合停止制御
// package.json scripts - npm統合コマンド
```

### 📊 実装結果

| 項目 | Before | After |
|------|--------|-------|
| **起動方法** | 3つのターミナル + 複雑手順 | `npm start` (1コマンド) |
| **停止方法** | 手動で個別停止 | `npm stop` (安全・確実) |
| **エラー対応** | 手動対応が必要 | 自動検出・復旧 |
| **学習コスト** | 高い（技術知識必要） | 低い（標準npmコマンド） |

## 結論

分離アーキテクチャの実装が完了し、さらに統合起動システムにより運用性が飛躍的に向上しました。セキュリティ、保守性、使いやすさの全てが大幅に改善されています。

**最終更新**: 2025年6月11日  
**実装完了**: Phase 1-4 全て完了  
**バージョン**: 3.2.0 (Unified Startup System)
