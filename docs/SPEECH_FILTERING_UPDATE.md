# 音声読み上げフィルタリング機能 修正履歴

## 概要
チャットボットのメッセージに含まれる「*」（アスタリスク）とURLを音声読み上げから除外する機能を実装しました。

## 修正日時
2025年6月11日

## 修正内容

### 1. 対象ファイル
- `public/script.js` - メインアプリケーション
- `legacy-files/script.js` - 後方互換性保持

### 2. 機能拡張
既存の`removeEmojis`関数を拡張し、以下の要素を音声読み上げから除外するように修正：

#### 除外対象
1. **絵文字** - 既存機能（Unicode絵文字ブロック）
2. **アスタリスク（*）** - 新規追加
3. **URL** - 新規追加
   - `https://` で始まるURL
   - `http://` で始まるURL  
   - `www.` で始まるURL
   - ドメイン形式のURL（例：`example.com`、`test.org`）

#### 処理フロー
```javascript
// 入力例: "*重要* https://example.com をチェック！😊"
// ↓
// 1. 絵文字除去: "*重要* https://example.com をチェック！"
// 2. URL除去: "*重要* をチェック！"
// 3. アスタリスク除去: "重要 をチェック！"
// 4. 空白整理: "重要 をチェック！"
```

### 3. 技術実装詳細

#### 正規表現パターン
```javascript
// URL検出パターン
const urlRegex = /https?:\/\/[^\s]+|www\.[^\s]+|[a-zA-Z0-9][a-zA-Z0-9-]*[a-zA-Z0-9]*\.([a-zA-Z]{2,})(\/[^\s]*)?/gi;

// アスタリスク検出パターン
const asteriskRegex = /\*/g;
```

#### 処理順序
1. 絵文字除去（既存）
2. URL除去（新規）
3. アスタリスク除去（新規）
4. 空白文字の正規化

### 4. 対応する音声エンジン
以下の全ての音声エンジンで同様にフィルタリングが適用されます：
- **Web Speech API** - ブラウザ内蔵
- **Google Cloud TTS** - クラウドベース
- **AivisSpeech Engine** - ローカル高品質

### 5. テスト機能

#### 自動テストページ
`dev-tools/test-speech-filtering.html` - ブラウザベースのテストページ

#### テストケース
- アスタリスク除去テスト
- 各種URL形式の除去テスト
- 絵文字除去テスト（既存）
- 複合要素テスト
- エッジケーステスト

#### テスト実行方法
```bash
# テストサーバー起動
python3 -m http.server 8081 --directory dev-tools

# ブラウザでアクセス
http://localhost:8081/test-speech-filtering.html
```

### 6. 動作例

| 入力テキスト | 音声読み上げテキスト |
|-------------|-------------------|
| `*重要*メッセージです` | `重要メッセージです` |
| `https://example.com を見て` | `を見て` |
| `詳細は www.google.com で` | `詳細は で` |
| `*注意* https://test.com 😊` | `注意` |

### 7. 設定変更
- 関数名: `removeEmojis` → 機能拡張（名前は後方互換性のため維持）
- コメント: 「絵文字除去」→「音声読み上げから除外する要素を削除」
- ログメッセージ: フィルタリング対象を明確化

## 備考
- 既存の絵文字除去機能は維持
- 後方互換性は完全に保持
- エラーハンドリングは既存のものを活用
- フィルタリング後にテキストが空になった場合は音声読み上げをスキップ

## 関連ファイル
- `docs/SPECIFICATION.md` - 音声機能の仕様書
- `public/script.js` - メイン実装
- `legacy-files/script.js` - レガシー実装
- `dev-tools/test-speech-filtering.html` - テストページ
- `dev-tools/test-speech-filtering.js` - テストスクリプト
