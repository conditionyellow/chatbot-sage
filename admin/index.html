<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot Sage - 管理画面</title>
    <link rel="stylesheet" href="admin-style.css">
</head>
<body>
    <div class="admin-container">
        <!-- ログイン画面 -->
        <div id="login-screen" class="login-screen">
            <div class="login-card">
                <h1>🔐 Chatbot Sage 管理画面</h1>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">ユーザー名:</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">パスワード:</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="login-btn">ログイン</button>
                </form>
                <div id="login-error" class="error-message"></div>
            </div>
        </div>

        <!-- メイン管理画面 -->
        <div id="admin-screen" class="admin-screen" style="display: none;">
            <!-- ヘッダー -->
            <header class="admin-header">
                <h1>📺 Chatbot Sage 管理画面</h1>
                <div class="header-actions">
                    <span id="user-info"></span>
                    <button id="logout-btn" class="logout-btn">ログアウト</button>
                </div>
            </header>

            <!-- ナビゲーション -->
            <nav class="admin-nav">
                <button class="nav-btn active" data-tab="dashboard">📊 ダッシュボード</button>
                <button class="nav-btn" data-tab="youtube">📺 YouTube設定</button>
                <button class="nav-btn" data-tab="system">⚙️ システム設定</button>
                <button class="nav-btn" data-tab="debug">🔧 デバッグ</button>
                <button class="nav-btn" data-tab="logs">📝 ログ</button>
            </nav>

            <!-- メインコンテンツ -->
            <main class="admin-main">
                <!-- ダッシュボード -->
                <div id="dashboard-tab" class="tab-content active">
                    <h2>📊 システム状況</h2>
                    
                    <div class="status-grid">
                        <div class="status-card">
                            <h3>YouTube 監視状況</h3>
                            <div class="status-indicator" id="youtube-monitoring-status">
                                <span class="status-dot offline"></span>
                                <span class="status-text">停止中</span>
                            </div>
                            <div class="status-details" id="youtube-details">
                                <p>ライブチャットID: <span id="live-chat-id">未設定</span></p>
                                <p>処理済みメッセージ: <span id="processed-messages">0</span></p>
                            </div>
                        </div>

                        <div class="status-card">
                            <h3>システム情報</h3>
                            <div class="status-details">
                                <p>サーバー状態: <span id="server-status" class="status-online">稼働中</span></p>
                                <p>最終更新: <span id="last-update">-</span></p>
                                <p>稼働時間: <span id="uptime">-</span></p>
                            </div>
                        </div>

                        <div class="status-card">
                            <h3>最新ログ</h3>
                            <div id="recent-logs" class="recent-logs">
                                <p>ログを読み込み中...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- YouTube設定 -->
                <div id="youtube-tab" class="tab-content">
                    <h2>📺 YouTube ライブチャット設定</h2>
                    
                    <form id="youtube-config-form">
                        <div class="form-group">
                            <label for="youtube-api-key">YouTube Data API v3 キー:</label>
                            <div class="api-key-input-group">
                                <input type="password" id="youtube-api-key" placeholder="AIzaSy... (39文字のAPIキー)">
                                <button type="button" id="toggle-api-key-visibility" class="toggle-visibility-btn" title="APIキーの表示/非表示を切り替え">👁️</button>
                            </div>
                            <small>Google Cloud ConsoleでYouTube Data API v3を有効化してAPIキーを取得してください</small>
                        </div>

                        <div class="api-key-setup-guide" style="margin-top: 1rem;">
                            <details>
                                <summary>🔧 APIキー制限設定のトラブルシューティング</summary>
                                <div class="setup-guide-content">
                                    <h4>HTTPリファラー制限エラーの解決方法</h4>
                                    <p><strong>エラー:</strong> "Requests from referer &lt;empty&gt; are blocked"</p>
                                    
                                    <h5>解決策 1: 制限を「なし」に設定（推奨）</h5>
                                    <ol>
                                        <li>Google Cloud Console → APIとサービス → 認証情報</li>
                                        <li>使用中のAPIキーをクリック</li>
                                        <li>「アプリケーションの制限」で「なし」を選択</li>
                                        <li>「保存」をクリック</li>
                                    </ol>
                                    
                                    <h5>解決策 2: HTTPリファラーにサーバーURLを追加</h5>
                                    <ol>
                                        <li>「アプリケーションの制限」で「HTTPリファラー」を選択</li>
                                        <li>以下のURLを追加:</li>
                                        <ul>
                                            <li><code>localhost/*</code></li>
                                            <li><code>127.0.0.1/*</code></li>
                                            <li><code>http://localhost:8081/*</code></li>
                                        </ul>
                                        <li>「保存」をクリック</li>
                                    </ol>
                                    
                                    <div class="warning-box">
                                        <strong>⚠️ 注意:</strong> 本番環境では適切なリファラー制限を設定してください
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div class="form-group">
                            <label for="video-id">ライブ配信ID:</label>
                            <input type="text" id="video-id" placeholder="例: dQw4w9WgXcQ または https://www.youtube.com/watch?v=dQw4w9WgXcQ">
                            <small>現在ライブ配信中の動画のIDまたはURLを入力してください</small>
                            
                            <div class="video-id-help" style="margin-top: 0.5rem;">
                                <details>
                                    <summary>📝 対応する入力形式</summary>
                                    <div class="help-content">
                                        <ul>
                                            <li><code>https://www.youtube.com/watch?v=VIDEO_ID</code></li>
                                            <li><code>https://youtu.be/VIDEO_ID</code></li>
                                            <li><code>https://www.youtube.com/live/VIDEO_ID</code></li>
                                            <li><code>VIDEO_ID</code> (11文字の動画ID直接入力)</li>
                                        </ul>
                                        <p><strong>注意:</strong> ライブチャットが有効なライブ配信のみ対応</p>
                                    </div>
                                </details>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="check-interval">チェック間隔（秒）:</label>
                            <input type="number" id="check-interval" min="5" max="60" value="10">
                            <small>ライブチャットをチェックする間隔（5-60秒）</small>
                        </div>

                        <div class="form-actions">
                            <button type="button" id="check-api-availability" class="check-btn">🔍 API可用性チェック</button>
                            <button type="button" id="test-connection" class="test-btn">🧪 接続テスト</button>
                            <button type="submit" class="save-btn">💾 設定保存</button>
                        </div>
                    </form>

                    <div id="youtube-test-result" class="test-result"></div>

                    <div class="monitoring-controls">
                        <h3>監視制御</h3>
                        <div class="control-buttons">
                            <button id="start-monitoring" class="start-btn">🎬 監視開始</button>
                            <button id="stop-monitoring" class="stop-btn" disabled>⏹️ 監視停止</button>
                        </div>
                        <div id="monitoring-status" class="monitoring-status">
                            <span class="status-dot offline"></span>
                            <span>監視停止中</span>
                        </div>
                    </div>
                </div>

                <!-- システム設定 -->
                <div id="system-tab" class="tab-content">
                    <h2>⚙️ システム設定</h2>
                    
                    <form id="system-config-form">
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="enable-logging" checked>
                                ログ記録を有効にする
                            </label>
                        </div>

                        <div class="form-group">
                            <label for="log-level">ログレベル:</label>
                            <select id="log-level">
                                <option value="error">エラーのみ</option>
                                <option value="warn">警告以上</option>
                                <option value="info" selected>情報以上</option>
                                <option value="debug">すべて</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="max-log-entries">最大ログ保存数:</label>
                            <input type="number" id="max-log-entries" min="100" max="10000" value="1000">
                        </div>

                        <button type="submit" class="save-btn">💾 設定保存</button>
                    </form>
                </div>

                <!-- デバッグツール -->
                <div id="debug-tab" class="tab-content">
                    <h2>🔧 開発・デバッグツール</h2>
                    
                    <!-- WebSocket接続状況 -->
                    <div class="debug-section">
                        <h3>🔌 WebSocket接続状況</h3>
                        <div class="debug-controls">
                            <span>管理画面接続: <span class="websocket-status disconnected">接続中...</span></span>
                            <span>フロントエンドクライアント: <span id="frontend-clients-count">0</span>台</span>
                            <button id="reconnect-websocket" class="test-btn">🔄 再接続</button>
                        </div>
                    </div>
                    
                    <!-- フロントエンド接続テスト -->
                    <div class="debug-section">
                        <h3>🌐 フロントエンド接続テスト</h3>
                        <div class="debug-controls">
                            <button id="test-frontend-connection" class="test-btn">🔗 フロントエンド接続確認</button>
                            <button id="get-frontend-status" class="test-btn">📊 フロントエンド状態取得</button>
                        </div>
                        <div id="frontend-test-result" class="test-result"></div>
                    </div>

                    <!-- 感情分析デバッグ -->
                    <div class="debug-section">
                        <h3>🎭 感情分析デバッグ</h3>
                        <div class="form-group">
                            <label for="debug-emotion-text">テスト用テキスト:</label>
                            <input type="text" id="debug-emotion-text" placeholder="例: 嬉しいです！とても幸せな気分です！">
                            <button id="analyze-emotion" class="test-btn">🧠 感情分析実行</button>
                        </div>
                        <div class="debug-controls">
                            <button id="run-emotion-tests" class="test-btn">🧪 感情分析テスト実行</button>
                            <button id="check-emotion-keywords" class="test-btn">📝 感情キーワード確認</button>
                        </div>
                        <div id="emotion-debug-result" class="test-result"></div>
                    </div>

                    <!-- Live2Dデバッグ -->
                    <div class="debug-section">
                        <h3>🎨 Live2Dデバッグ</h3>
                        <div class="debug-controls">
                            <button id="check-live2d-status" class="test-btn">🎭 Live2D状態確認</button>
                            <button id="test-live2d-expressions" class="test-btn">😊 表情テスト</button>
                            <button id="test-live2d-motions" class="test-btn">💃 モーションテスト</button>
                        </div>
                        <div id="live2d-debug-result" class="test-result"></div>
                    </div>

                    <!-- Live2D感情コントロール（NEW） -->
                    <div class="debug-section">
                        <h3>🎭 Live2D感情コントロール</h3>
                        <div class="emotion-control-panel">
                            <div class="emotion-buttons">
                                <button id="set-expression-smile" class="emotion-btn smile" title="笑顔">😊 笑顔</button>
                                <button id="set-expression-surprised" class="emotion-btn surprised" title="驚き">😮 驚き</button>
                                <button id="set-expression-sad" class="emotion-btn sad" title="悲しみ">😢 悲しみ</button>
                                <button id="set-expression-angry" class="emotion-btn angry" title="怒り">😠 怒り</button>
                                <button id="set-expression-normal" class="emotion-btn normal" title="通常">😐 通常</button>
                            </div>
                            <div class="emotion-status">
                                <span class="status-label">現在の表情:</span>
                                <span id="current-expression-display" class="current-expression">通常</span>
                            </div>
                        </div>
                        <div id="emotion-control-result" class="test-result"></div>
                    </div>

                    <!-- システム統合テスト -->
                    <div class="debug-section">
                        <h3>🔄 システム統合テスト</h3>
                        <div class="debug-controls">
                            <button id="run-quick-test" class="test-btn">⚡ クイックテスト</button>
                            <button id="run-full-system-test" class="test-btn">🏁 完全システムテスト</button>
                            <button id="clear-debug-output" class="clear-btn">🗑️ 結果クリア</button>
                        </div>
                        <div id="system-test-result" class="test-result"></div>
                    </div>

                    <!-- デバッグ出力 -->
                    <div class="debug-section">
                        <h3>📋 デバッグ出力</h3>
                        <div class="debug-output" id="debug-output">
                            <p>デバッグ情報がここに表示されます</p>
                        </div>
                    </div>
                </div>

                <!-- ログ -->
                <div id="logs-tab" class="tab-content">
                    <h2>📝 システムログ</h2>
                    
                    <div class="logs-controls">
                        <div class="filter-controls">
                            <label for="log-filter-level">レベル:</label>
                            <select id="log-filter-level">
                                <option value="">すべて</option>
                                <option value="error">エラー</option>
                                <option value="warn">警告</option>
                                <option value="info">情報</option>
                                <option value="debug">デバッグ</option>
                            </select>
                            <button id="refresh-logs" class="refresh-btn">🔄 更新</button>
                            <button id="clear-logs" class="clear-btn">🗑️ ログクリア</button>
                        </div>
                    </div>

                    <div id="logs-container" class="logs-container">
                        <p>ログを読み込み中...</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script src="admin-websocket.js"></script>
    <script src="admin-script.js"></script>
</body>
</html>
